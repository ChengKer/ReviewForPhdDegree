## 第十章 数据库恢复技术

1. **事务**是一个数据库操作序列，是恢复和并发控制的基本单位

   ```sql
   /*事务的定义*/
   BEGIN TRANSACTION
    	SQL1
    	SQL2
    	...
    	COMMIT
   
   BEGIN TRANSACTION
    	SQL1
    	SQL2
    	...
    	ROLLBACK
   ```

2. 事务的特性：ACID

   - 原子性：一个事务是一个不可分割的工作单位，事务中包括的操作要么都做要么都不做
   - 一致性：事务必须是使数据库从一个一致性状态到另一个一致性状态
   - 隔离性：一个事务的执行不能被其他事务干扰
   - 持久性：一个事务一旦提交，它对数据库中数据的改变就是持久性的。接下来的其他操作故障不应该对其有影响

3. 恢复操作的基本原理：冗余，利用存储在系统其他地方的冗余数据来重建数据库中已被破坏或不正确的那部分数据

4. 冗余数据建立：

   - 数据转储：转储是指DBA定期将真个数据库复制到磁带，磁盘或其他存储介质上保存下来的过程，备用的数据称为后备副本或后援副本

     - 数据库遭到破坏后可以将后备副本重新装入
     - 重装后副本只能将书库恢复到转储时的状态
     - 转储方法：

     | 静态转储                                                     | 动态转储                                                     |
     | ------------------------------------------------------------ | ------------------------------------------------------------ |
     | 在系统无运行事务时进行的转储操作，转储必须等待正在运行的用户事务结束，新的事务必须等转储结束 | 转储操作与用户事务并发进行，需要把动态转储期间各事务对数据库的修改活动记录下来，建立日志文件。后备副本+日志文件才能把数据库恢复到某一时刻的正确状态 |

     | 海量转储                                                     | 增量转储                                                     |
     | ------------------------------------------------------------ | ------------------------------------------------------------ |
     | 每次都转储全部数据库，使用海量转储得到的后备副本进行恢复往往更方便 | 只转储上次转储后又更新过的数据，如果数据库很大，事务处理也很频繁，那么使用增量转储更好 |

   - 登录日志文件：

     - 日志文件(log)的格式：一记录为单位 | 以数据块为单位

     - 登录日志文件：登录的次序严格按照并行事务执行的事件次序，必须**先写日志文件**，后写数据库。

       P.S. 先写日志文件：写数据库和写日志文件是两个不同的操作，在这两个操作之间可能发生故障，如果先写了数据库修改而在这个日志文件中没有登记下这个修改，则以后就无法恢复这个修改了，如果先写日志文件，但是没有修改数据库，按日志文件恢复时只不过是多执行依次不必要的UNDO操作，并不会影响数据库的正确性

5. 事务故障：事务在运行至正常终止点前被终止。

   恢复方法：由恢复子系统利用**日志文件** 撤销（**UNDO**）此事务已对数据库进行的修改

   - 从后向前找到扫描日志文件
   - 对该事务的更新执行逆操作，即将日志记录中“更新前的值”写入数据库
   - 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理
   - 如此处理下去，直到读到此事务的开始标记，事务故障恢复就完成了

6. 系统故障：未完成事务对数据库的更新已写入数据库；已提交事务对数据库的更新还**留在缓冲区**没写入数据库

   恢复方法：Uedo故障发生时未完成的事务，Redo已完成的事务

   - 正向扫描文件(从前向后扫描文件)
     - Redo队列：在故障发生前已经提交的事务：既有 `BEGIN TRANSCATION` 记录用，也有 `COMMIT` 记录
     - Undo队列：故障发生时未完成的事务：这些事务只有 `BEGIN TRANSCATION` 记录，无相应的COMMIT记录
   - 对撤销(Undo)队列事务进行撤销(Undo)处理，即从反向扫描，将“更新前的值”写入数据库
   - 对重做(Redo)队列事务进行重做(Redo)处理，即正向扫描，将“更新后的值”写入数据库
   - 如此处理下去，直到读到此事务的开始标记，事务故障恢复就完成了

7. 介质故障的恢复

   - 重装数据库
   - 装入转储结束时刻后的日志文件副本，Redo已完成的任务

8. 具有检查点(check point)的恢复技术

   - 在日志中增加**检查点记录**
   - 增加**重新开始文件**
   - 恢复子系统在登录日志文件期间动态地维护日志
   - 检查点记录的内容
     - 建立检查点时刻所有正在执行的事务清单
     - 这些事务最近一个日志记录的地址
   - 重新开始文件的内容：记录各个检查点记录在日志文件中的地址
   - 动态维护日志文件的方法：周期性的：建立检查点→保存数据库状态
     - 具体步骤：写日志→写检查点到日志→写数据→写检查点到重新开始文件
     - 因此记录在重新开始文件中的检查点之前的事务都已经被写入了
     - 持续到检查点之后故障之前的不一定被全部写入，因此需要Redo
     - 持续到故障之后的需要Undo
   - 恢复步骤：
     - 从重新开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址在日志文件中找到最后一个检查点记录
     - 由该检查点记录得到检查点建立时刻所有正在执行的事务清单 `ACTIVE-LIST`，建立两个事务队列 `UNDO-LIST`，`REDO-LIST`，把 `ACTIVE-LIST` 暂时放入 `UNDO-LIST` 队列，REDO队列暂时为空
     - 从检查点开始正向扫描日志文件，直到日志文件结束
       - 如果有新开始的事务 $T_i$，把 $T_i$ 暂时放入 `UNDO-LIST` 队列
       - 如果有提交的事务 $T_j$，把 $T_j$ 从`UNDO-LIST` 转移到 `REDO-LIST`



